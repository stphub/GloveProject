<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glove Sensor: XYZ Monitor & Fall Safety</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #f8fafc; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 95%; max-width: 1200px; }
        .card { background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 20px; background: #334155; }
        .online { color: #4ade80; border: 1px solid #4ade80; }
        h1 { color: #38bdf8; margin-bottom: 10px; }
        .value-display { font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: flex; gap: 20px; color: #94a3b8; }
        .x { color: #ef4444; } .y { color: #22c55e; } .z { color: #3b82f6; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 12px 25px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-find { background: #eab308; color: #000; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        .btn-reset { background: #334155; color: #f8fafc; border: 1px solid #475569; }
        .btn:hover { transform: scale(1.05); opacity: 0.9; }
        
        .exercise-card { border: 2px solid #22c55e; text-align: center; }
        .counter-val { font-size: 4rem; font-weight: bold; color: #22c55e; margin: 10px 0; }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .history-card { border: 1px solid #ef4444; }
        .history-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; text-align: left; }
        .history-item { padding: 8px; border-bottom: 1px solid #334155; color: #fca5a5; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h1>üß§ Glove Real-time Dashboard</h1>
    
    <div class="btn-group">
        <button id="findGloveBtn" class="btn btn-find">üîç FIND MY GLOVE (‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)</button>
        <button id="resetExerciseBtn" class="btn btn-reset">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
    </div>

    <div id="status" class="status">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</div>

    <div class="grid">
        <div class="card exercise-card">
            <h3>üèãÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Wrist Count)</h3>
            <div id="valExercise" class="counter-val">0</div>
            <p style="color: #94a3b8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Å‡∏£‡∏∞‡∏î‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
        </div>

        <div class="card history-card">
            <h3 style="color: #ef4444;">üö® ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="fallHistory" class="history-list">
                <div class="history-item" style="color: #94a3b8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°</div>
            </div>
        </div>

        <div class="card">
            <h3>Accelerometer (X, Y, Z)</h3>
            <canvas id="xyzChart"></canvas>
            <div class="value-display">
                <span class="x">X: <span id="valX">0</span></span>
                <span class="y">Y: <span id="valY">0</span></span>
                <span class="z">Z: <span id="valZ">0</span></span>
            </div>
        </div>

        <div class="card">
            <h3>Resultant Force (Total G)</h3>
            <canvas id="gChart"></canvas>
            <div class="value-display">
                <span style="color: #fbbf24;">G-Force: <span id="valG">0</span> m/s¬≤</span>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAY9TqQEY_PsbC2dHniwKVQCJFkmMGRlTI",
            databaseURL: "https://glove-a8c55-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Find Me
        document.getElementById('findGloveBtn').addEventListener('click', () => {
            db.ref("/SmartGlove/Control").update({ findMe: true }).then(() => {
                const btn = document.getElementById('findGloveBtn');
                btn.innerText = "üîî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å...";
                setTimeout(() => btn.innerText = "üîç FIND MY GLOVE (‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)", 2000);
            });
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset Exercise
        document.getElementById('resetExerciseBtn').addEventListener('click', () => {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                db.ref("/SmartGlove/Live").update({ exerciseCount: 0 });
            }
        });

        // Chart Setup
        const commonOptions = { animation: false, scales: { y: { beginAtZero: false } }, elements: { point: { radius: 0 } } };
        const xyzChart = new Chart(document.getElementById('xyzChart'), {
            type: 'line',
            data: { labels: Array(30).fill(''), datasets: [
                { label: 'X', data: [], borderColor: '#ef4444', borderWidth: 2 },
                { label: 'Y', data: [], borderColor: '#22c55e', borderWidth: 2 },
                { label: 'Z', data: [], borderColor: '#3b82f6', borderWidth: 2 }
            ]},
            options: commonOptions
        });
        const gChart = new Chart(document.getElementById('gChart'), {
            type: 'line',
            data: { labels: Array(30).fill(''), datasets: [{ label: 'Total G', data: [], borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.2)', fill: true }]},
            options: { ...commonOptions, scales: { y: { min: 0, max: 40 } } }
        });

        let lastFallState = false;

        // Listen to Firebase
        db.ref("/SmartGlove/Live").on("value", (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById('status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Streaming)";
                document.getElementById('status').className = "status online";

                document.getElementById('valX').innerText = (data.x || 0).toFixed(2);
                document.getElementById('valY').innerText = (data.y || 0).toFixed(2);
                document.getElementById('valZ').innerText = (data.z || 0).toFixed(2);
                document.getElementById('valG').innerText = (data.total_g || 0).toFixed(2);
                document.getElementById('valExercise').innerText = data.exerciseCount || 0;

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏° (Fall History Logic) ---
                if (data.isFallen === true && lastFallState === false) {
                    const historyBox = document.getElementById('fallHistory');
                    if(historyBox.innerText.includes("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥")) historyBox.innerHTML = "";
                    
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString() + " (" + now.toLocaleDateString() + ")";
                    const newEntry = document.createElement('div');
                    newEntry.className = "history-item";
                    newEntry.innerHTML = "üö® <b>‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°:</b> " + timeStr;
                    historyBox.prepend(newEntry); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
                }
                lastFallState = data.isFallen;

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
                [xyzChart.data.datasets[0].data, xyzChart.data.datasets[1].data, xyzChart.data.datasets[2].data].forEach((dataset, i) => {
                    if (dataset.length > 30) dataset.shift();
                    dataset.push(i === 0 ? data.x : i === 1 ? data.y : data.z);
                });
                xyzChart.update();
                if (gChart.data.datasets[0].data.length > 30) gChart.data.datasets[0].data.shift();
                gChart.data.datasets[0].data.push(data.total_g);
                gChart.update();
            }
        });
    </script>
</body>
</html>
